name: Bump Dev Version

on:
  repository_dispatch:
    types: [bump_dev]

jobs:
  bump:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: dev
          token: ${{ secrets.REPO_DISPATCH_TOKEN }}
      
      - name: Bump version
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          python -c "
          import re
          from pathlib import Path
          f = Path('tentacle/__init__.py')
          txt = f.read_text()
          def bump(m):
              ma, mi, pa = int(m[1]), int(m[2]), int(m[3])
              pa += 1
              if pa > 99: pa, mi = 0, mi + 1
              if mi > 99: mi, ma = 0, ma + 1
              return f'__version__ = \"{ma}.{mi}.{pa}\"'
          f.write_text(re.sub(r'__version__\s*=\s*[\"\\'](\d+)\.(\d+)\.(\d+)[\"\\']', bump, txt))
          "
          
          VERSION=$(grep -oP '__version__\s*=\s*["\x27]\K[^"\x27]+' tentacle/__init__.py)
          
          git add tentacle/__init__.py
          git commit -m "Bump version to $VERSION [skip ci]"
          git push origin dev
          
          echo "Bumped dev to $VERSION"
      
      - name: Update requirements.txt
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          PYTHONTK_VER=$(pip index versions pythontk 2>/dev/null | grep -oP 'Available versions: \K[^,]+' || echo "0.7.36")
          UITK_VER=$(pip index versions uitk 2>/dev/null | grep -oP 'Available versions: \K[^,]+' || echo "1.0.37")
          MAYATK_VER=$(pip index versions mayatk 2>/dev/null | grep -oP 'Available versions: \K[^,]+' || echo "0.9.40")
          sed -i "s/pythontk==.*/pythontk==$PYTHONTK_VER/" requirements.txt
          sed -i "s/uitk==.*/uitk==$UITK_VER/" requirements.txt
          sed -i "s/mayatk==.*/mayatk==$MAYATK_VER/" requirements.txt
          
          git add requirements.txt
          
          if ! git diff --staged --quiet; then
            git commit -m "Update requirements.txt [skip ci]"
            git push origin dev
          fi
